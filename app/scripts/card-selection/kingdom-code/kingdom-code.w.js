function closeWithError(r){postMessage({result:"error",message:r})}function convertKingdomToCode(r){importScripts(r.appDir+"/scripts/marknote.w.js");var e=[],a=void 0,s=void 0;for(card of r.kingdomCards){for(var t=r.totalSets[card.cardSet].toString();t.length<2;)t="0"+t;var o=t+card.cardNumber.toString();e.push(o),r.baneCard===card&&(a=o),r.obeliskCard===card&&(s=o)}var d=[],p=new marknote.Parser,l=p.parseURL(r.appDir+"/data/supply.xml",null,"GET");if(200===p.getXHRStatus()){var i=l.getRootElement().getChildElements("card");for(xmlSupplyCard of i)for(supplyCardName of(xmlSupplyCardName=xmlSupplyCard.getAttributeValue("name"),xmlSupplyCardNumber=xmlSupplyCard.getAttributeValue("n"),r.supplyCards))supplyCardName===xmlSupplyCardName&&d.push(xmlSupplyCardNumber)}var n="a"+d.join("a")+"aa"+e.join("a");void 0!==a?(n+="aa"+a,void 0!==s&&(n+="a"+s)):void 0!==s&&(n+="aa0a"+s);var m=baseConvert(n,11,BASECODE.length,BASECODE);postMessage({result:"success",kingdomCode:m})}function convertCodeToKingdom(r){importScripts(r.appDir+"/scripts/marknote.w.js"),importScripts(r.appDir+"/scripts/card-selection/xml-to-card.w.js"),postMessage({result:"progress",progress:1}),kingdomCode=r.kingdomCode;var e=baseConvert(kingdomCode,BASECODE.length,11,BASECODE).substring(1).split("aa"),a=e[0],s=e[1],t=e[2],o=void 0,d=void 0;if(void 0!==t){var p=t.split("a");o=p[0],d=p[1]}var l=a.split("a"),i=s.split("a");i.length<10&&closeWithError("The kingdom code was not valid"),postMessage({result:"progress",progress:2});var n={},m={},C={};for(id of i)setCode=id.substring(0,2),void 0===n[setCode]&&(n[setCode]=[]),cardCode=id.substring(2),n[setCode].push(cardCode),void 0!==o&&id===o&&(m.setCode=setCode,m.cardCode=cardCode),void 0!==d&&id===d&&(C.setCode=setCode,C.cardCode=cardCode);postMessage({result:"progress",progress:3}),kingdomCards=[];var u=void 0,g=void 0;for(set in n){var c="",v=void 0;for(name in r.totalSets){for(var S=r.totalSets[name].toString();S.length<2;)S="0"+S;set===S&&(c=name,v=S)}var f=c.toLowerCase().replace(" ","")+".xml",y=r.appDir+"/data/cards/"+f,E=(h=new marknote.Parser).parseURL(y,null,"GET");if(200===h.getXHRStatus()){c=(k=E.getRootElement()).getAttributeValue("name");var x=k.getChildElements();for(xmlSet of x){var b=xmlSet.getChildElements("card");for(xmlCard of b)for(kingdomCardId of(cardId=xmlCard.getAttributeValue("n"),n[set]))kingdomCardId===cardId&&(cardData=xmlToCardData(xmlCard,c),kingdomCards.push(cardData),m.setCode===v&&m.cardCode===cardId&&(u=cardData),C.setCode===v&&C.cardCode===cardId&&(g=cardData))}}}postMessage({result:"progress",progress:6}),supplyCards=[];var h;E=(h=new marknote.Parser).parseURL(r.appDir+"/data/supply.xml",null,"GET");if(200===h.getXHRStatus()){var k,D=(k=E.getRootElement()).getChildElements("card");for(xmlSupplyCard of D)for(supplyCardId of(xmlSupplyCardName=xmlSupplyCard.getAttributeValue("name"),xmlSupplyCardNumber=xmlSupplyCard.getAttributeValue("n"),l))xmlSupplyCardNumber===supplyCardId&&supplyCards.push(xmlSupplyCardName)}postMessage({result:"progress",progress:8}),kingdomCards.length<10&&closeWithError("Not enough cards");var N={result:"success",kingdomCards:kingdomCards,supplyCards:supplyCards,obeliskCard:g,baneCard:u};postMessage(N)}BASECODE="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",self.addEventListener("message",function(r){parameters=r.data,importScripts("BigInteger.min.w.js"),importScripts("base-convert.w.js"),"cards-to-code"===parameters.request?convertKingdomToCode(parameters):"code-to-cards"===parameters.request?convertCodeToKingdom(parameters):closeWithError("Invalid request")});